# Exercice 5â€“ SÃ©curiser Ghost avec NetworkPolicies

Ã€ partir de la solution Ghost fonctionnelle (ClusterIP + NodePort), l'Ã©quipe sÃ©curitÃ© demande d'implÃ©menter des NetworkPolicies pour contrÃ´ler et sÃ©curiser les communications rÃ©seau entre les composants.

---

## Contexte de sÃ©curitÃ©

L'Ã©quipe sÃ©curitÃ© a identifiÃ© que **par dÃ©faut, tous les pods peuvent communiquer entre eux** dans Kubernetes. Pour respecter le principe de **moindre privilÃ¨ge**, vous devez implÃ©menter des NetworkPolicies qui :

1. **Bloquent tout le trafic par dÃ©faut**
2. **Autorisent uniquement les communications nÃ©cessaires**
3. **ProtÃ¨gent MySQL contre les accÃ¨s non autorisÃ©s**
4. **Permettent l'accÃ¨s externe Ã  Ghost uniquement**

---

## PrÃ©requis

Vous devez avoir la solution Ghost fonctionnelle avec :
- MySQL dÃ©ployÃ© avec service ClusterIP
- Ghost dÃ©ployÃ© avec services ClusterIP et NodePort
- AccÃ¨s Ã  Ghost via `http://localhost:30080`

---

## Architecture de sÃ©curitÃ© cible

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EXTERNE                            â”‚
â”‚  âœ… http://localhost:30080  â†’ Ghost NodePort            â”‚
â”‚  âŒ Tout autre accÃ¨s bloquÃ©                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ (autorisÃ©)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                GHOST APPLICATION                        â”‚
â”‚  âœ… ReÃ§oit trafic externe (NodePort)                   â”‚
â”‚  âœ… Peut accÃ©der Ã  MySQL                               â”‚
â”‚  âŒ Ne peut PAS accÃ©der Ã  d'autres services            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ (autorisÃ©)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 MYSQL DATABASE                          â”‚
â”‚  âœ… ReÃ§oit connexions de Ghost uniquement              â”‚
â”‚  âŒ BLOQUE tout autre trafic                           â”‚
â”‚  âŒ Pas d'accÃ¨s externe                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---


### 2. ImplÃ©menter une NetworkPolicy "Deny All"

**CrÃ©er une politique par dÃ©faut qui bloque tout le trafic :**
- Nom : `default-deny-all`
- Effet : Bloquer tout le trafic entrant (Ingress)
- PortÃ©e : Tous les pods du namespace default

### 3. CrÃ©er une NetworkPolicy pour MySQL

**Politique pour MySQL :**
- Nom : `mysql-network-policy`
- Autoriser le trafic entrant uniquement depuis les pods Ghost
- Port autorisÃ© : 3306
- Protocole : TCP

### 4. CrÃ©er une NetworkPolicy pour Ghost

**Politique pour Ghost :**
- Nom : `ghost-network-policy`
- Autoriser le trafic entrant depuis :
  - L'extÃ©rieur (pour NodePort)
  - Les autres pods Ghost (pour ClusterIP)
- Port autorisÃ© : 2368
- Protocole : TCP

### 5. CrÃ©er une NetworkPolicy pour les sorties de Ghost

**Politique pour les sorties de Ghost :**
- Nom : `ghost-egress-policy`
- Autoriser Ghost Ã  accÃ©der Ã  :
  - MySQL (port 3306)
  - DNS (port 53)
  - Internet pour les mises Ã  jour (optionnel)



### SchÃ©ma

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                EXTERNE                                      â”‚
â”‚  ğŸŒ Internet / Utilisateurs                                                â”‚
â”‚                                                                             â”‚
â”‚  ğŸ’» curl http://localhost:30080                                            â”‚
â”‚  ğŸŒ curl http://ghost.local (si Ingress)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ Port 30080 (NodePort)
                                      â”‚ âœ… AutorisÃ© par ingress: - {}
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CLUSTER K3D                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚                         NODE k3d-ghost-blog-server-0                    â”‚ â”‚
â”‚ â”‚                                                                         â”‚ â”‚
â”‚ â”‚  ğŸ”§ Service: ghost-nodeport-service                                     â”‚ â”‚
â”‚ â”‚     Type: NodePort                                                      â”‚ â”‚
â”‚ â”‚     Port: 80 â†’ 2368                                                     â”‚ â”‚
â”‚ â”‚     NodePort: 30080                                                     â”‚ â”‚
â”‚ â”‚                                  â”‚                                      â”‚ â”‚
â”‚ â”‚                                  â”‚ Port 2368                            â”‚ â”‚
â”‚ â”‚                                  â–¼                                      â”‚ â”‚
â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚  â”‚                      GHOST PODS                                 â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  ğŸ“¦ ghost-pod-1        ğŸ“¦ ghost-pod-2                          â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  Labels: app=ghost     Labels: app=ghost                       â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  Port: 2368           Port: 2368                               â”‚   â”‚ â”‚
â”‚ â”‚  â”‚                                                                 â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  ğŸ”’ NetworkPolicy: ghost-network-policy                        â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  â”‚ INGRESS (Trafic ENTRANT)                               â”‚   â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  â”‚ âœ… - {} (depuis partout)                               â”‚   â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  â”‚ âœ… - from: podSelector: app=ghost (entre pods Ghost)   â”‚   â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  â”‚    ports: TCP/2368                                     â”‚   â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  â”‚                                                         â”‚   â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  â”‚ EGRESS (Trafic SORTANT)                                â”‚   â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  â”‚ âœ… â†’ MySQL (app=mysql) port TCP/3306                   â”‚   â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  â”‚ âœ… â†’ DNS (to: {}) ports UDP/53, TCP/53                â”‚   â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  â”‚ âœ… â†’ Internet (to: {}) port TCP/443                    â”‚   â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚ â”‚
â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â”‚                                  â”‚                                      â”‚ â”‚
â”‚ â”‚                                  â”‚ Port 3306                            â”‚ â”‚
â”‚ â”‚                                  â”‚ âœ… AutorisÃ© par mysql-network-policy â”‚ â”‚
â”‚ â”‚                                  â–¼                                      â”‚ â”‚
â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚  â”‚                      MYSQL POD                                  â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  ğŸ“¦ mysql-pod-0                                                 â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  Labels: app=mysql                                              â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  Port: 3306                                                     â”‚   â”‚ â”‚
â”‚ â”‚  â”‚                                                                 â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  ğŸ”’ NetworkPolicy: mysql-network-policy                        â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  â”‚ INGRESS (Trafic ENTRANT)                               â”‚   â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  â”‚ âœ… SEULEMENT depuis podSelector: app=ghost             â”‚   â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  â”‚    ports: TCP/3306                                     â”‚   â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  â”‚ âŒ Tout autre trafic BLOQUÃ‰                            â”‚   â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚ â”‚
â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â”‚                                                                         â”‚ â”‚
â”‚ â”‚  ğŸ”§ Service: mysql-service                                              â”‚ â”‚
â”‚ â”‚     Type: ClusterIP                                                     â”‚ â”‚
â”‚ â”‚     ClusterIP: 10.43.x.x                                                â”‚ â”‚
â”‚ â”‚     Port: 3306 â†’ 3306                                                   â”‚ â”‚
â”‚ â”‚                                                                         â”‚ â”‚
â”‚ â”‚  ğŸ”§ Service: ghost-clusterip-service                                    â”‚ â”‚
â”‚ â”‚     Type: ClusterIP                                                     â”‚ â”‚
â”‚ â”‚     ClusterIP: 10.43.x.x                                                â”‚ â”‚
â”‚ â”‚     Port: 80 â†’ 2368                                                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  ğŸ”’ NetworkPolicy: default-deny-all                                        â”‚
â”‚     Bloque TOUT le trafic par dÃ©faut                                       â”‚
â”‚     Seules les exceptions explicites sont autorisÃ©es                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```